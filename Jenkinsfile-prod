pipeline {
  agent any

  environment {
    IMAGE_NAME = "sahil867/msil-demo-repo"
    KUBE_CTX   = "context-oke-amaaaaaaksfnvmaahftwc5deha4gq3zu"
  }

  stages {

    stage('Approval') {
      steps {
        input message: 'Approve deployment to PROD?'
      }
    }

    stage('Read DEV Image Tag') {
      steps {
        script {
          IMAGE_TAG = sh(
            script: "cat /var/lib/jenkins/last-dev-image.txt",
            returnStdout: true
          ).trim()

          echo "Promoting image tag: ${IMAGE_TAG}"
        }
      }
    }

    stage('Deploy to PROD') {
      steps {
        sh """
          sed 's/IMAGE_TAG/${IMAGE_TAG}/g' k8s/prod/deployment.yaml > /tmp/prod-deploy.yaml

          kubectl --context ${KUBE_CTX} -n prod apply -f /tmp/prod-deploy.yaml
        """
      }
    }

    stage('Verify Deployment') {
      steps {
        sh """
          kubectl --context ${KUBE_CTX} -n prod rollout status deployment/demo-app
        """
      }
    }
  }
}
