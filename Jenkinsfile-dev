pipeline {
  agent any

  environment {
    IMAGE_NAME  = "sahil867/msil-demo-repo"
    IMAGE_TAG   = "${BUILD_NUMBER}"
    KUBE_CTX    = "context-oke-amaaaaaaksfnvmaahftwc5deha4gq3zu"

    HTTP_PROXY  = "http://10.115.208.19:80"
    HTTPS_PROXY = "http://10.115.208.19:80"
    NO_PROXY    = "localhost,127.0.0.1"
  }

  stages {

    stage('Docker Login') {
      steps {
        withCredentials([usernamePassword(
          credentialsId: 'dockerhub-creds',
          usernameVariable: 'DOCKER_USER',
          passwordVariable: 'DOCKER_PASS'
        )]) {
          sh """
            echo \$DOCKER_PASS | docker login -u \$DOCKER_USER --password-stdin
          """
        }
      }
    }

    stage('Build & Push Image') {
      steps {
        sh """
          echo "HTTP_PROXY=$HTTP_PROXY"
          echo "HTTPS_PROXY=$HTTPS_PROXY"

          docker build \
            --build-arg HTTP_PROXY=$HTTP_PROXY \
            --build-arg HTTPS_PROXY=$HTTPS_PROXY \
            --build-arg NO_PROXY=$NO_PROXY \
            -t $IMAGE_NAME:$IMAGE_TAG \
            -f docker/Dockerfile .

          docker push $IMAGE_NAME:$IMAGE_TAG
        """
      }
    }

    stage('Deploy to DEV') {
      steps {
        sh """
          kubectl --context $KUBE_CTX -n dev set image deployment/demo-app \
          demo-app=$IMAGE_NAME:$IMAGE_TAG
        """
      }
    }
  }
}
