pipeline {
  agent any

  environment {
    IMAGE_NAME = "bom.ocir.io/oscemea006/demo-app-repo"
    IMAGE_TAG  = "${BUILD_NUMBER}"
    KUBE_CTX   = "context-oke-amaaaaaaksfnvmaahftwc5deha4gq3zu"
  }

  stages {

    stage('Docker Login to OCIR') {
      steps {
        withCredentials([
          usernamePassword(
            credentialsId: 'ocir-creds',
            usernameVariable: 'OCIR_USER',
            passwordVariable: 'OCIR_TOKEN'
          )
        ]) {
          sh '''
            echo "$OCIR_TOKEN" | docker login bom.ocir.io -u "$OCIR_USER" --password-stdin
          '''
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        sh 'docker build -f docker/Dockerfile -t ${IMAGE_NAME}:${IMAGE_TAG} .'
      }
    }

    stage('Push Docker Image') {
      steps {
        sh 'docker push ${IMAGE_NAME}:${IMAGE_TAG}'
      }
    }

    stage('Deploy to DEV') {
      steps {
        sh '''
          sed "s/IMAGE_TAG/${IMAGE_TAG}/g" k8s/dev/deployment.yaml | \
          kubectl --context ${KUBE_CTX} apply -f -
        '''
      }
    }

    stage('Save Image Tag for PROD') {
      steps {
        sh 'echo ${IMAGE_TAG} > /var/lib/jenkins/last-dev-image.txt'
      }
    }
  }

  post {

    failure {
      slackSend(
        color: "danger",
        message: """
❌ *Pipeline Failed*
*Job:* ${JOB_NAME}
*Build:* #${BUILD_NUMBER}
*Image:* ${IMAGE_NAME}:${IMAGE_TAG}
*URL:* ${BUILD_URL}
"""
      )
    }

    success {
      slackSend(
        color: "good",
        message: """
✅ *Pipeline Success*
*Job:* ${JOB_NAME}
*Build:* #${BUILD_NUMBER}
*Image:* ${IMAGE_NAME}:${IMAGE_TAG}
"""
      )
    }
  }
}
