pipeline {
  agent any

  environment {
    KUBE_CTX = "context-oke-amaaaaaaksfnvmaahftwc5deha4gq3zu"
    PROD_NS  = "prod-1"
    APP_NAME = "hello-nginx"
  }

  stages {

    stage('Approval') {
      steps {
        input message: 'Approve PROD rollback?'
      }
    }

    stage('Rollback') {
      steps {
        sh """
          kubectl --context ${KUBE_CTX} -n ${PROD_NS} \
            rollout undo deployment/${APP_NAME}
        """
      }
    }

    stage('Verify') {
      steps {
        sh """
          kubectl --context ${KUBE_CTX} -n ${PROD_NS} \
            rollout status deployment/${APP_NAME}
        """
      }
    }
  }
}
